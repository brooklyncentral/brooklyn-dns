brooklyn.catalog:
  version: "0.2.0-SNAPSHOT" # BROOKLYN_DNS_VERSION
  description: |
    Entities for working with BIND and DNS servers
  publish:
    overview: README.md
    license_code: APACHE-2.0
    license_url: http://www.apache.org/licenses/LICENSE-2.0.txt

  items:
    - id: brooklyn-dns-bind-server
      name: "Brooklyn DNS BIND Server"
      description: |
        A BIND server which will automatically pick up any entity
        with the 'brooklyn_dns.enabled' config key set to true
      itemType: entity
      iconUrl: classpath://io.brooklyn.dns:icons/dns.png
      item:
        type: org.apache.brooklyn.entity.network.bind.BindDnsServer
        id: brooklyn-dns-bind-server
        name: "brooklyn-dns-bind-server"

        brooklyn.parameters:
          - name: brooklyn_dns.domain
            label: "Domain Name"
            description: |
              The domain name suffix to use for generated hostnames
            default: "brooklyn.local"

          - name: brooklyn_dns.hosts.filter.config
            label: "Filtering Config Key"
            description: |
              The name of the config key set on other entities to indicate that this server
              should pick up their address

              (the only reason to change from the default 'brooklyn_dns.enabled'
              is if you are running multiple BIND servers picking up different entities)
            default: brooklyn_dns.enabled

          - name: brooklyn_dns.hosts.basename.sensor
            label: "Basename Sensor"
            description: |
              The sensor giving the host basename on entities for which this provides name serving;
              the domain name is appended to the basename coming from that entity
            type: org.apache.brooklyn.api.sensor.AttributeSensor
            default: $brooklyn:sensor("org.apache.brooklyn.core.entity.Attributes", "entity.id")

          - name: brooklyn_dns.hosts.address.sensor
            label: "IP Address Sensor"
            description: |
              The sensor giving the IP address on entities for which this provides name serving;
              usually of the form 'host...address...', defaulting to the public IP address
              but if all nodes are in a private subnet 'host.subnet.address' may be better
            type: org.apache.brooklyn.api.sensor.AttributeSensor
            default: $brooklyn:sensor("org.apache.brooklyn.core.entity.Attributes", "host.address")

          - name: brooklyn_dns.entityfilter
            label: "Entity Filter"
            description: |
              A predicate that will selct the entities whose addresses will be served by
              this BIND server; the default behaviour selects entities with the filtering
              configuration key set to true
            type: com.google.common.base.Predicate
            default:
              $brooklyn:object:
                type: org.apache.brooklyn.core.entity.EntityPredicates
                factoryMethod.name: "configEqualTo"
                factoryMethod.args:
                  - $brooklyn:config("brooklyn_dns.hosts.filter.config")
                  - true

        brooklyn.config:
          bind.domain.name: $brooklyn:config("brooklyn_dns.domain")
          bind.sensor.hostname: $brooklyn:config("brooklyn_dns.hosts.basename.sensor")
          bind.sensor.address: $brooklyn:config("brooklyn_dns.hosts.address.sensor")

          filter: $brooklyn:config("brooklyn_dns.entityfilter")

          # TODO remove when Aug brooklyn-library PR is merged
          namedConfTemplate:
            https://raw.githubusercontent.com/ahgittin/brooklyn-library/bind-dns-improvements/software/network/src/main/resources/org/apache/brooklyn/entity/network/bind/named.conf

        # TODO remove when Aug brooklyn-library PR is merged
        brooklyn.initializers:
          - type: org.apache.brooklyn.core.sensor.StaticSensor
            brooklyn.config:
              name: bind.serial
              static.value: 201608001

    - id: brooklyn-dns-registration-hook
      name: "Brooklyn DNS Registration Hook"
      description: |
        Configures the VM to register with and use the DNS server located at the
        brooklyn_dns.address config key (IP address string)
      itemType: entity
      iconUrl: classpath://io.brooklyn.dns:icons/dns.png
      item:
        type: org.apache.brooklyn.entity.software.base.VanillaSoftwareProcess
        id: brooklyn-dns-registration-hook
        name: "brooklyn-dns-registration-hook"

        brooklyn.parameters:
          - name: brooklyn_dns.domain
            label: "Domain Name"
            description: |
              The domain name suffix to use for generated hostnames
            default: "brooklyn.local"

          - name: brooklyn_dns.address
            label: "DNS Server Address"
            description: |
              The address of the DNS server to put in resolv.conf, often an expression such as
              '$brooklyn:entity("brooklyn-dns-bind-server").attributeWhenReady("host.address")'
              (which is the default, so if your BIND DNS server entity has id
              'brooklyn-dns-bind-server' and is accessible on its public IP address,
              this config can be omitted)
            default: $brooklyn:entity("brooklyn-dns-bind-server").attributeWhenReady("host.address")

        brooklyn.config:
          # tells our DNS server to register this node (you can set this on other nodes also)
          brooklyn_dns.enabled: true

          shell.env:
            # TODO make brooklyn_dns.server a parameter
            BROOKLYN_DNS_SERVER_ADDRESS: $brooklyn:config("brooklyn_dns.address")
            MY_HOSTNAME: $brooklyn:attributeWhenReady("brooklyn_dns.host.name")

          install.command: |
            # put our nameserver at the front of resolv.conf
            ( echo "nameserver ${BROOKLYN_DNS_SERVER_ADDRESS}" ; cat /etc/resolv.conf ) | sudo tee /etc/resolv.conf
            # also put in the head file if resolvconf is used to autogenerate the file above
            if [ -f /etc/resolvconf/resolv.conf.d/head ] ; then
              ( echo "nameserver ${BROOKLYN_DNS_SERVER_ADDRESS}" ; cat /etc/resolvconf/resolv.conf.d/head ) | sudo tee /etc/resolvconf/resolv.conf.d/head
              sudo resolvconf -u
            fi

          launch.command: |
            echo "(nothing needed to make this run, BIND should pick us up)"

          checkRunning.command: |
            ping -c 1 ${MY_HOSTNAME}

        brooklyn.initializers:
          - # publish the full hostname for convenience; anyone can then subscribe to this
            type: org.apache.brooklyn.core.sensor.StaticSensor
            brooklyn.config:
              name: brooklyn_dns.host.name
              static.value:
                $brooklyn:formatString:
                  - "%s.%s"
                  - $brooklyn:parent().attributeWhenReady("entity.id")
                  - $brooklyn:config("brooklyn_dns.domain")
